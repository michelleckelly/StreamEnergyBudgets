---
title: "Defining Nutrient Cycling Regimes"
description: A nationwide analysis of nitrogen fixation, denitrification, and ecosystem metabolism in streams.
author: 
  - name: "Michelle Catherine Kelly"
    url: https://michelleckelly.github.io
    affiliation: Michigan Tech
  - name: "Kevin Nevorski"
    url: https://twitter.com/KNevorski?s=20
    affiliation: Michigan Tech
  - name: "Erin K. Eberhard"
    url: https://twitter.com/Erin_K_Eberhard?s=20
    affiliation: Michigan Tech
  - name: "Amy M. Marcarelli"
    url: http://marcarelli-lab.bio.mtu.edu/
    affiliation: Michigan Tech
date: "`r format(Sys.Date())`"
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_depth: 2
---

# Abstract


-------

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# Load libraries
library(tidyverse)
library(lubridate)
library(plotrix)
library(gridExtra)
library(ggmap)
library(ggrepel)
library(maps)
library(wesanderson)
library(corrplot)
```

```{r load_compiledStreamPULSE, echo = FALSE, message = FALSE, warning = FALSE}
############## Load site attributes data ############## 
sites <- read.csv(file = "data/CAREER_SiteAttributes.csv")

############## Load and clean StreamPULSE metabolism data ############## 
# Create list of file names using site ID information
fileRegEx <- unique(paste0("predictions_",
                          sites$StreamPULSE_SiteID,".*rds"))
# Pull paths of matching file names
fileList <- lapply(fileRegEx, 
                   function(x){list.files(path = "data/all_sp_model_objects",
                                          pattern = x, full.names = T)})
fileList <- unlist(fileList)
# Load model results from files
modelResults <- sapply(fileList, readRDS, simplify = F, USE.NAMES = T)

# Create dummy function to calculate standard error
se <- function(x){
  sd(x, na.rm = T)/sqrt(length(na.omit(x)))
}

# Flatten list
modelResults <- bind_rows(modelResults, .id = "site")

# Format daily data
modelResults_all <- 
  modelResults %>%
  mutate(site = str_match(site, "predictions_(\\w{2}_\\w+)_")[,2],
         NEP = GPP - abs(ER),
         DOY = yday(date),
         year = as.factor(year(date)))

# Compute averages by month
modelResults_monthly <-
  modelResults %>%
  mutate(month = month(ymd(date), label = TRUE),
         site = str_match(site, "predictions_(\\w{2}_\\w+)_")[,2]) %>%
  group_by(site, month) %>%
  summarise(GPP_sd = sd(GPP, na.rm = T), 
            GPP_mean = mean(GPP, na.rm = T),
            ER_sd = sd(ER, na.rm = T),
            ER_mean = mean(ER, na.rm = T),
            # Calculate NEP as GPP - ER
            NEP_mean = mean(GPP - abs(ER), na.rm = T),
            NEP_sd = sd(GPP - abs(ER), na.rm = T))

# Compute averages by DOY
modelResults_DOY <-
  modelResults %>%
  mutate(DOY = yday(date),
         site = str_match(site, "predictions_(\\w{2}_\\w+)_")[,2]) %>%
  group_by(site, DOY) %>%
  summarise(GPP_sd = sd(GPP, na.rm = T), 
            GPP_mean = mean(GPP, na.rm = T),
            ER_sd = sd(ER, na.rm = T),
            ER_mean = mean(ER, na.rm = T),
            NEP_mean = mean(GPP - abs(ER), na.rm = T),
            NEP_sd = sd(GPP - abs(ER), na.rm = T))

############## Load and clean StreamPULSE nutrient data ############## 



############## Load nutrient process rates data ############## 
Nprocess <- read_csv(file = "data/CAREER_RatesTable.csv")
# Unite site code row with Nprocess table
#Nprocess <- left_join(Nprocess, sites[c(1,4)], by = "SiteName") # This isn't being matched correctly
Nprocess$date <- mdy(Nprocess$date)

# Unite with metabolism data
Nprocess <- 
  left_join(Nprocess, modelResults_all, 
            by = c("date", "StreamPULSE_SiteID" = "site")) 

# Filter to fixation and unamended denit
Nprocess <- 
  Nprocess %>%
  #filter(Process == "NFixation" | Process == "UnamendedDenit") %>%
  drop_na(StreamPULSE_SiteID) %>%
  #filter(Substrate %in% c("Sediment", "Rock", "Wood")) %>%
  select(-AFDM, -Chla, -SubstrateArea, -SubstrateVolume, -msgs.fit, -warnings, 
         -errors, -DOY, -year)
# Set Process names
Nprocess$Process <- factor(Nprocess$Process, 
         levels = c("N fixation", "UnamendedDenit", "Amended"),
         labels = c("Nitrogen Fixation", "Unamended Denitrification", 
                    "Amended Denitrification"))

# Widen data
#Nprocess_w <- 
#  Nprocess %>%
#  pivot_wider(names_from = Process, values_from = c(ProcessRate, SE))

# Subset only rates measured on sediment, wood, or rock
#Nprocess_subst <- 
#  Nprocess_w %>%
#  filter(Substrate %in% c("sediment", "rock", "wood")) %>%
#  pivot_wider(names_from = Substrate, 
#              values_from = c(ProcessRate_UnamendedDenit, ProcessRate_NFixation, 
#                              SE_UnamendedDenit, SE_NFixation))
```

```{r model_StreamPULSE, eval = FALSE}
# 18 Feb 2020
# This chunk is for modeling metabolism for sites with model records not yet
# compiled on StreamPULSE

# Load libraries
library(StreamPULSE)
library(streamMetabolizer)

# Choose model type and framework
model_type <- "bayes"
model_name <- "streamMetabolizer"

# Request variables
vars <- c('DO_mgL','DOsat_pct','satDO_mgL','WaterPres_kPa',
          'Depth_m','WaterTemp_C','Light_PAR','AirPres_kPa',
          'Discharge_m3s', "ChlorophyllA_ugL", "Nitrate_mgL")

site_code <- "MI_PILG1"

# Request all streampulse data at site for all time
sp_data <- request_data(sitecode = site_code, variables = vars)
# Format data for metabolism modeling
sp_data_prepped <- prep_metabolism(d=sp_data, type=model_type, 
                                   model=model_name, 
                                   rm_flagged = list("Bad Data", "Questionable"), 
                                   #interval = "5 min",
                                   estimate_areal_depth = TRUE,
                                   #retrieve_air_pres = TRUE
                                   )
# Fit model and generate predictions
model_fit <- fit_metabolism(sp_data_prepped)
plot_output(model_fit)


## See if you can pull in NEON discharge data with NEON utilities package
```

# Methods

### Notes on StreamPULSE Data Availability for Metabolism Modeling

Arikaree River, CO_ARIK-down

- Sampled on 2017-07-11 and 2019-05-24
- CO_ARIK-down has much more data coverage than CO_ARIK-up
- 2017 metabolism
  - Depth measurements run from 2017-01-01 to 2017-06-01
  - Most coverage of DO is 2017-03-26 to 2017-05-26
- 2018 metabolism
  - Good coverage across full year (except for nitrate)
- 2019 metabolism
  - Depth measurements run from 2019-01-01 to 2019-06-01
  - DO measurements spotty between 2019-01-01 to 2019-06-01, most coverage between 2019-04-18 to 2019-05-20
  
Red Butte Creek, UT_REDB-up

Pringle Creek, TX_PRIN-up

McDiffet Creek, KS_MCDI-up

Kings Creek, KS_KING-up

Hubbard Brook Forest, NH_HBF

- Sampled on 2018-08-07

Wednesday Hill Brook, NH_WHB

- Sampled on 2018-08-09

Lower Hop Brook, MA_HOPB-down

Rio Guilarte, 	PR_GUIL-up

- These rates and forward not yet calculated

Rio Cupeyes, PR_CUPE-up

Sycamore Creek, AZ_SYCA-up

Caribou Creek, AK_CARI-up

Blacktail Deer Creek, WY_BLDE-up

McRae Creek, OR_MCRA-up

Martha Creek, WA_MART-up



```{r plotMap, fig.cap="Map of StreamPULSE (n = 12) and NEON (n = 13) study sites used in this analysis. Blue = StreamPULSE site, orange = NEON site. (would be neat to have a way to show years of metabolism record for each site on this map)", echo = FALSE, message = FALSE, warning = FALSE, fig.pos="center", fig.height=6, fig.width = 10}
# Pull state map data
world.map <- map_data("world")
states.map <- map_data("state")

# Plot map
ggplot() +
  # State and country outlines
  geom_polygon(data = world.map, aes(x = long, y = lat, group = group), 
               color = "grey", size = 0.2, fill = NA) +
  geom_polygon(data = states.map, aes(x = long, y = lat, group = group), 
               color = "grey", size = 0.2, fill = NA) +
  geom_polygon(data = subset(world.map, region == "USA"), 
               aes(x = long, y = lat, group = group), 
               color = "black", size = 0.2, fill = NA) +
  # Location markers and labels
  geom_label_repel(data = sites, aes(x = Longitude, y = Latitude, 
                                     label = SiteName), 
                   box.padding = 1, size = 4, nudge_x = 0.01, 
                   segment.size = 0.5, segment.color = "black", 
                   label.size = 0.6) +
  geom_point(data = sites, aes(x = Longitude, y = Latitude, fill = Source), 
             shape = 21, 
             color = "black", size = 4, stroke = 1) +
  coord_fixed(1.3, xlim = c(-30,-180), ylim = c(10, 75)) +
  # Theme adjustments
  theme_nothing() +
  theme(panel.background = element_rect(color = "black", fill = "white")) +
  scale_fill_manual(values=wes_palette(n=4, name="FantasticFox1")) +
  guides(fill = FALSE)
```

```{r plotNEPmonthlymean, eval = F, fig.cap="Time series data of daily NEP (grey lines) and calculated mean NEP for each day of year (colored lines, A), and calculated mean monthly NEP (B) for the period of record. Shaded ribbons (B) represent standard deviation of NEP.", echo = FALSE, message = FALSE, warning = FALSE, fig.height=5.5, fig.width = 8, fig.pos="center"}
# Plot of DOY vs GPP or ER, faceted by site
a <- 
  ggplot(data = NULL) +
  # Facet wrap plots
  facet_wrap(~site, nrow = 3) +
  # Lines for all years of data
  geom_line(data = modelResults_all, aes(x = DOY, y = NEP, linetype = year), color = "darkgrey", alpha = 0.7) +
  # Lines for mean data
  geom_line(data = modelResults_DOY, aes(x = DOY, y = NEP_mean, color = site)) +
  geom_hline(yintercept = 0, linetype = 2) +
  # Axis labels and scales
  ylab(expression("NEP (g"~O[2]~m^2~"d"^{-1}*")")) +
  xlab("Day of year") +
  labs(tag = "A") +
  # Remove legend for site
  guides(color = FALSE, linetype = guide_legend(nrow = 3, title = "Year")) +
  # Theme adjustments
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        panel.background = element_rect(color = "black"),
        legend.position = "bottom") +
  # Color scales
  scale_color_brewer(palette = 2, type = "qual")

# Plot of average NEP by month, all sites on one plot
b <- 
  ggplot(data = modelResults_monthly, aes(x = month, group = site)) +
  # Ribbon for visualizing standard error
  geom_ribbon(aes(ymin = NEP_mean-NEP_sd, 
                  ymax = NEP_mean+NEP_sd, fill = site), alpha = 0.1)+
  # Line and points for mean NEP
  geom_line(aes(y = NEP_mean, color = site)) +
  geom_point(aes(y = NEP_mean, color = site), 
             shape = 21, fill = "white", size = 2) +
  # Horizontal line at y = 0
  geom_hline(yintercept = 0, linetype = 2) +
  # Axis labels and scales
  labs(tag = "B", fill = "Site", color = "Site") +
  ylab(expression("NEP (g"~O[2]~m^2~"d"^{-1}*")")) +
  xlab("Day of year") +
  # Theme adjustments
  guides(color = guide_legend(nrow = 3), fill = guide_legend(nrow = 3))+
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        panel.background = element_rect(color = "black"), 
        legend.position = "bottom") +
  # Color scales
  scale_color_brewer(palette = 2, type = "qual") +
  scale_fill_brewer(palette = 2, type = "qual")

grid.arrange(a,b, ncol = 2)
```

```{r plotNEPloess, fig.cap="Time series data of daily NEP (grey lines) and calculated mean NEP for each day of year (colored lines, A), and annual trends in NEP over the period of record visualized using local polynomial regression fitting (LOESS, B). Shaded ribbons (B) represent 95% confidence interval on LOESS estimate.", echo = FALSE, message = FALSE, warning = FALSE, fig.height=5.5, fig.width = 8, fig.pos="center"}
# Plot of DOY vs GPP or ER, faceted by site
c <- 
  ggplot(data = NULL) +
  # Facet wrap plots
  facet_wrap(~site, nrow = 3) +
  # Lines for all years of data
  geom_line(data = modelResults_all, aes(x = DOY, y = NEP, linetype = year), color = "darkgrey", alpha = 0.7) +
  # Lines for mean data
  geom_line(data = modelResults_DOY, aes(x = DOY, y = NEP_mean, color = site)) +
  
  geom_hline(yintercept = 0, linetype = 2) +
  # Axis labels and scales
  ylab(expression("NEP (g"~O[2]~m^2~"d"^{-1}*")")) +
  xlab("Day of year") +
  labs(tag = "A") +
  # Remove legend for site
  guides(color = FALSE, linetype = guide_legend(nrow = 3, title = "Year")) +
  # Theme adjustments
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        panel.background = element_rect(color = "black"),
        legend.position = "bottom") +
  # Color scales
  scale_color_brewer(palette = 2, type = "qual")

# LOESS smooth
d <- 
  ggplot(data = modelResults_all, aes(x = DOY, y = NEP)) +
  stat_smooth(aes(color = site, fill = site), method = "loess") +
  # Horizontal line at y = 0
  geom_hline(yintercept = 0, linetype = 2) +
  # Axis labels and scales
  labs(tag = "B", fill = "Site", color = "Site") +
  ylab(expression("NEP (g"~O[2]~m^2~"d"^{-1}*")")) +
  xlab("Month") +
  # Theme adjustments
  guides(color = guide_legend(nrow = 3), fill = guide_legend(nrow = 3))+
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        panel.background = element_rect(color = "black"), 
        legend.position = "bottom") +
  # Color scales
  scale_color_brewer(palette = 2, type = "qual") +
  scale_fill_brewer(palette = 2, type = "qual")

grid.arrange(c,d, ncol = 2)



# Compute PCA of metabolism data
prcomp(modelResults_all[,c(3,6,12,13)], center = T, scale. = T)


modelResults_all %>%
  select(GPP, ER, NEP, DOY)

# Compute Kmediods using pam (Partitioning Around Medoids) from cluster
collsub_kmediods <- pam(colleges_sub, k = 3)
# For K-mediods results
fviz_cluster(collsub_kmediods, data = colleges_sub) + 
  labs(tag = "B", title = "K-mediods clustering") +
  theme_classic() +
  theme(legend.position = "none")
```

```{r plotNProcessRates, fig.cap="Nitrogen fixation and denitrification rates measured on the dominant substrate (macrophyte, rock, sediment, or wood; where rock includes rock flock, rock cobble, rock scrape, bedrock scrape, pebble, and bedrock; sediment includes clay) at each study site. Vertical black lines extend from the first quartile minus 1.5 times the interquartile range to the third quartile plus 1.5 times the interquartile range. Note that y-axis is on a log scale.", echo = FALSE, message = FALSE, warning = FALSE, fig.height=5, fig.width = 10, fig.pos="center"}
Nprocess_plot <- Nprocess
  # Group rock cobble and rock flock into rock category
Nprocess_plot$Substrate <- recode(Nprocess_plot$Substrate, "Rock Flock" = "Rock", 
                             "Rock Cobble" = "Rock", "Rock scrape" = "Rock",
                             "Bedrock scrape" = "Rock", "Pebble" = "Rock",
                             "Bedrock" = "Rock",
                             "Clay" = "Sediment")

ggplot(data = Nprocess_plot, aes(x = SiteName, y = ProcessRate)) +
  stat_boxplot(geom = "errorbar", width = 0, height = 0) +
  geom_point(aes(fill = Substrate, shape = Substrate), size = 4) +
  #geom_stat() +
  # Facet wrap plots
  facet_wrap(~Process, ncol = 3) +
  # Axis labels and scales
  ylab(expression("Rate (ug-N"~m^2~"hr"^{-1}*")")) +
  xlab("Site") +
  # Theme adjustments
  scale_y_log10(labels = scales::comma) +
  #scale_y_continuous(limits = c(0, NA)) +
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        panel.background = element_rect(color = "black"), 
        legend.position = "bottom") +
  # Color scales
  scale_shape_manual(values = c(21, 24, 22, 23)) +
  scale_fill_brewer(palette = 2, type = "qual")
```

```{r plotNProcessRates-flip, fig.cap="Nitrogen fixation and denitrification rates measured on the dominant substrate (macrophyte, rock, sediment, or wood; where rock includes rock flock, rock cobble, rock scrape, bedrock scrape, pebble, and bedrock; sediment includes clay) at each study site. Vertical black lines extend from the first quartile minus 1.5 times the interquartile range to the third quartile plus 1.5 times the interquartile range. Note that y-axis is on a log scale.", echo = FALSE, message = FALSE, warning = FALSE, fig.height=10, fig.width = 5, fig.pos="center"}
ggplot(data = Nprocess_plot, aes(x = SiteName, y = ProcessRate)) +
  stat_boxplot(geom = "errorbar", width = 0, height = 0) +
  geom_point(aes(fill = Substrate, shape = Substrate), size = 4) +
  #geom_stat() +
  # Facet wrap plots
  facet_wrap(~Process, ncol = 1) +
  # Axis labels and scales
  ylab(expression("Rate (ug-N"~m^2~"hr"^{-1}*")")) +
  xlab("Site") +
  # Theme adjustments
  scale_y_log10(labels = scales::comma) +
  #scale_y_continuous(limits = c(0, NA)) +
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        #axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        panel.background = element_rect(color = "black"), 
        legend.position = "bottom") +
  # Color scales
  scale_shape_manual(values = c(21, 24, 22, 23)) +
  scale_fill_brewer(palette = 2, type = "qual") +
  coord_flip()
```

```{r correlations, fig.cap="Correlations between predictor variables, computed using Pearson correlation", echo = FALSE, message = FALSE, warning = FALSE, fig.height=5, fig.width = 5, fig.pos="center"}
# Subset only rates measured on sediment or rock, seperate into columns, 
# Get rid of non-numeric columns
corrmatrix <- 
  Nprocess %>%
  filter(ProcessRate > 0) %>% # Only use non-zero rates
  mutate(absvalER = abs(ER), ER = NULL) %>%
  select(-SE, -GPP.lower, -GPP.upper, -ER.lower, -ER.upper) %>%
  pivot_wider(names_from = Process, values_from = ProcessRate) %>%
  filter(Substrate %in% c("Sediment", "Rock", "Wood", "Macrophyte")) %>%
  #pivot_wider(names_from = Substrate, 
   #           values_from = c(UnamendedDenit, NFixation)) %>%
  # Filter out non-numeric columns
  select(-date, -SiteName, -StreamPULSE_SiteID, -Substrate)

# Plot correlation
corrplot(cor(corrmatrix, use = "pairwise.complete.obs"), #order = "hclust", 
         type = "upper", tl.col = "black", addgrid.col = F, outline = T, 
         addCoef.col = "white", tl.cex = 0.8)

# Test denitrificiation vs GPP, denit vs ER
cor.test(x = corrmatrix$`Unamended Denitrification`, y = corrmatrix$GPP)
cor.test(x = corrmatrix$`Unamended Denitrification`, y = corrmatrix$absvalER)
```

```{r NEPProcessRate, eval = FALSE, fig.cap="Nitrogen fixation and denitrification rates and net ecosystem production (NEP) on day of sampling at each study site.", echo = FALSE, message = FALSE, warning = FALSE, fig.height=5, fig.width = 8, fig.pos="center"}
# Faceted plot of N Fixation and Unamended Denitrification against NEP
ggplot(data = Nprocess_subst) +
  geom_point(aes(x = ProcessRate_UnamendedDenit_rock, y = abs(ER), color = "rock")) +
  geom_point(aes(x = ProcessRate_UnamendedDenit_sediment, y = abs(ER), color = "sediment")) 

ggplot(data = Nprocess_subst) +
  geom_point(aes(x = ProcessRate_UnamendedDenit_rock, y = NEP, color = "rock")) +
  geom_point(aes(x = ProcessRate_UnamendedDenit_sediment, y = NEP, color = "sediment")) +
  scale_x_continuous(limits = c(1, NA))

ggplot(data = Nprocess_subst) +
  geom_point(aes(x = ProcessRate_NFixation_rock, y = NEP, color = "rock")) +
  geom_point(aes(x = ProcessRate_NFixation_sediment, y = NEP, color = "sediment")) 
  scale_x_continuous(limits = c(1, NA))

ggplot(data = Nprocess) +
  geom_point(aes(y = GPP, x = ProcessRate, 
                 color = StreamPULSE_SiteID, #fill = site, 
                 shape = Substrate
                 ), size = 4) +
  # Horizontal line at y = 0
  geom_hline(yintercept = 0, linetype = 2) +
  # Facet wrap plots
  facet_wrap(~Process, nrow = 1, scales = "free_x") +
  scale_x_continuous(limits = c(0, NA))+
  # Theme adjustments
  ylab(expression("GPP (g"~O[2]~m^2~"d"^{-1}*")")) +
  xlab(expression("Rate (ug-N"~m^2~"hr"^{-1}*")")) +
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        panel.background = element_rect(color = "black")) #+
  # Color scales
  #scale_color_brewer(palette = 2, type = "qual")
```

## Acknowledgments {.appendix}

We thank C. Allison, A. Copley, J. Cornell, E. Coscarelli, A. Eckersell, H. Harris, D. Larson, J. Ortiz, J. Paris, H. Roose, R. Schipper, and R. Van Goethem for field and laboratory assistance. This research was funded by the National Science Foundation Grant DEB 14-51919 to Amy M. Marcarelli.

Additional data sets were provided by the StreamPULSE Network, with funding provided by the National Science Foundation Macrosystems program (NSF Grant EF 14-42439). The National Ecological Observatory Network is a program sponsored by the National Science Foundation and operated under cooperative agreement by Battelle Memorial Institute. This material is based in part upon work supported by the National Science Foundation through the NEON Program. 

